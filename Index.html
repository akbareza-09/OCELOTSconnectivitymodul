<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>How does larval dispersal connect MPAs and OECMs in the seascape?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        .map-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #e0f2fe; /* Light ocean blue */
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #bae6fd;
        }
        @media (min-width: 768px) {
            .chart-container { height: 400px; }
        }
        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #0284c7;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            border: 2px solid white;
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 3px;
        }
        .species-btn {
            transition: all 0.2s ease;
        }
        .species-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-color: #0ea5e9;
        }
    </style>
    <!-- Chosen Palette: Ocean Science - Slate (Neutral), Sky Blue (Ocean/Primary), Teal (MPA), Orange (OECM) -->
    <!-- Application Structure Plan: 
         1. Header & Context: Centralized question mapping larval dispersal.
         2. Simulation & Spatial Map: Side-by-side PLD slider with interactive species presets and dynamic HTML5 Canvas map showing physical connections.
         3. The Connectivity Matrix: Heatmap of the 6x6 data.
         4. Network Analysis Dashboard: Graph Theory metrics comparing MPAs and OECMs.
         5. Synthesis/Implications: Tailored to spatial planning in this specific hypothetical network.
    -->
    <!-- Visualization & Content Choices:
         1. Spatial Map: Custom HTML5 Canvas. Goal: Relationships/Visualize. Dynamically draws nodes (MPA/OECM colored) and bezier curve edges based on matrix weights. NO SVG used.
         2. PLD Impact: Slider + Emoji Buttons. Goal: Change.
         3. Connectivity Matrix: Plotly Heatmap (6x6). Goal: Relationships.
         4. Source/Sink Balance: Chart.js Stacked Bar (6 nodes). Goal: Compare.
         5. Graph Metrics: Chart.js Radar Chart. Goal: Compare single node profile.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="bg-slate-50 text-slate-800 antialiased selection:bg-sky-200">

    <!-- Navigation -->
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <!-- Blank branding area as requested -->
                    <span class="text-xl font-bold text-slate-900 tracking-tight"></span>
                </div>
                <div class="hidden sm:flex space-x-8 items-center">
                    <button onclick="scrollToSection('simulation')" class="text-slate-500 hover:text-sky-600 px-1 py-2 text-sm font-semibold transition-colors">Spatial Network</button>
                    <button onclick="scrollToSection('matrix')" class="text-slate-500 hover:text-sky-600 px-1 py-2 text-sm font-semibold transition-colors">Matrix Data</button>
                    <button onclick="scrollToSection('analysis')" class="text-slate-500 hover:text-sky-600 px-1 py-2 text-sm font-semibold transition-colors">Node Roles</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-12">

        <!-- 1. Introduction Section -->
        <section id="intro" class="text-center max-w-4xl mx-auto">
            <h1 class="text-3xl md:text-5xl font-extrabold text-slate-900 mb-6 tracking-tight leading-tight">How does larval dispersal connect MPAs and OECMs in the seascape?</h1>
            <p class="text-lg text-slate-600 leading-relaxed mb-4">
                Marine connectivity can be visualized in many ways‚Äîfrom complex mathematical matrices and graph theory metrics to interactive spatial maps. Here, we'll dive deeper into how these visual tools work together to tell a story about ocean life.
            </p>
            <p class="text-lg text-slate-600 leading-relaxed">
                In this hypothetical case, we will see the connections between <strong>3 Marine Protected Areas (MPAs)</strong> and <strong>3 Other Effective area-based Conservation Measures (OECMs)</strong> using a simulated dispersal model. Adjust the biological parameters to see how ocean currents bind these conservation zones together!
            </p>
        </section>

        <!-- 2. Simulation & Spatial Map -->
        <section id="simulation" class="scroll-mt-20">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                    
                    <!-- Controls -->
                    <div class="lg:col-span-4 flex flex-col justify-center space-y-6">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-900 mb-2">Simulate Dispersal</h2>
                            <p class="text-sm text-slate-500 mb-4">
                                Adjust the <strong>Pelagic Larval Duration (PLD)</strong> to simulate different species. Watch how the spatial network connections (lines) react on the map.
                            </p>
                        </div>

                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <label for="pld-slider" class="block text-sm font-medium text-slate-700 mb-4">
                                Larval Duration (Days): <span id="pld-value" class="text-sky-600 font-bold text-2xl ml-2">30</span>
                            </label>
                            <input type="range" id="pld-slider" min="10" max="60" value="30" step="1" class="w-full">
                            <div class="flex justify-between text-xs text-slate-400 mt-3 font-semibold uppercase tracking-wider mb-6">
                                <span>10d (Local)</span>
                                <span>60d (Widespread)</span>
                            </div>

                            <!-- Interactive Species References -->
                            <div class="border-t border-slate-200 pt-4">
                                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-2">Species Reference (Click to apply)</p>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="setPLD(10)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">ü¶™ Giant Clam (10d)</button>
                                    <button onclick="setPLD(24)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">üêü Rabbitfish (24d)</button>
                                    <button onclick="setPLD(28)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">üê† Coral Trout (28d)</button>
                                    <button onclick="setPLD(35)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">üêü Snapper (35d)</button>
                                    <button onclick="setPLD(45)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">üêô Octopus (45d)</button>
                                    <button onclick="setPLD(60)" class="species-btn px-2 py-1.5 bg-white border border-slate-200 rounded-md text-xs font-medium text-slate-600 hover:text-sky-700">ü¶û Spiny Lobster (60d)</button>
                                </div>
                                <div class="mt-3 text-[10px] text-slate-500 italic leading-relaxed bg-slate-50/50 p-2 rounded border border-slate-100">
                                    <strong>* Scientific Note:</strong> These PLD values are general approximations derived from literature for illustrative purposes. In reality, larval duration and actual dispersal networks vary significantly depending on localized oceanographic currents, water temperature, seasonal spawning dynamics, and active larval swimming behavior.
                                </div>
                            </div>
                        </div>
                        
                        <div id="pld-insight" class="bg-sky-50 border-l-4 border-sky-500 p-4 rounded text-sm text-sky-900 leading-relaxed">
                            Initializing simulation...
                        </div>

                        <!-- Legend -->
                        <div class="flex items-center space-x-6 pt-2">
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 rounded-full bg-teal-500"></div>
                                <span class="text-xs font-bold text-slate-600">MPA</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-4 rounded-full bg-orange-400"></div>
                                <span class="text-xs font-bold text-slate-600">OECM</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-4 h-1 bg-sky-400 opacity-60"></div>
                                <span class="text-xs font-bold text-slate-600">Larval Flow</span>
                            </div>
                        </div>
                    </div>

                    <!-- Spatial Network Map (Custom Canvas) -->
                    <div class="lg:col-span-8 flex flex-col">
                        <h3 class="text-xl font-bold text-slate-800 mb-3">Spatial Network Map</h3>
                        <div class="map-container relative shadow-inner flex-grow">
                            <canvas id="spatialMapCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                            <div class="absolute bottom-3 right-3 bg-white/80 backdrop-blur px-3 py-1 rounded text-xs font-mono text-slate-500 border border-slate-200 shadow-sm">
                                Hypothetical Spatial Layout
                            </div>
                        </div>
                        <div class="mt-4 bg-sky-50 border border-sky-100 rounded-lg p-4 text-sm text-slate-700 leading-relaxed">
                            <strong>ü§î How to read this map:</strong> This visualization helps us instantly spot the physical pathways created by ocean currents.
                            <ul class="list-disc pl-5 mt-2 space-y-2">
                                <li><strong>Watch the lines:</strong> Notice how they change when you adjust the slider? Thicker, darker lines mean a stronger flow of larvae between two locations. Do you see the connections bridging the strictly protected MPAs (teal) to the sustainably managed OECMs (orange)?</li>
                                <li><strong>Watch the circles:</strong> A larger circle means more larvae stay at their home reef (local retention). Short PLDs create large circles because babies settle quickly, while long PLDs shrink them as larvae drift far away.</li>
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- 3. The Connectivity Matrix -->
        <section id="matrix" class="scroll-mt-20">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 space-y-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900">Probability Matrix</h2>
                        <p class="text-sm text-slate-600 mt-2">
                            The raw data driving the map. Rows show where larvae start (Source), columns show where they settle (Destination). 
                            Darker blues indicate a higher probability of connection. The diagonal line shows larvae staying at their home reef.
                        </p>
                    </div>

                    <!-- Key Stats -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-4 border border-slate-200 rounded-xl shadow-sm">
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Avg Self-Recruitment</div>
                            <div id="metric-retention" class="text-2xl font-black text-slate-800">--%</div>
                        </div>
                        <div class="bg-white p-4 border border-slate-200 rounded-xl shadow-sm">
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Active Corridors</div>
                            <div id="metric-connections" class="text-2xl font-black text-slate-800">--</div>
                        </div>
                        <div class="col-span-2 bg-white p-4 border border-slate-200 rounded-xl shadow-sm">
                            <div class="text-[10px] text-slate-400 uppercase font-bold tracking-wider mb-1">Strongest Link</div>
                            <div id="metric-link" class="text-lg font-bold text-sky-600 truncate">--</div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <div id="matrixChart" class="w-full h-[380px]"></div>
                    <div class="mt-2 bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-700 leading-relaxed mx-2 mb-2">
                        <strong>ü§î How to read this matrix:</strong> Reading a matrix might look intimidating, but it's just a grid of probabilities! Look at the row on the left (where larvae start) and follow it to a column (where they settle). A darker blue square means a higher chance of connection. 
                        <br><br>
                        See the diagonal line of squares going from top-left to bottom-right? That represents larvae staying at their home reef ('self-recruitment'). <strong>Try setting the slider to 10 days:</strong> this diagonal will turn dark blue because most babies stay home. <strong>Now slide it to 60 days:</strong> watch how that diagonal fades to white as larvae are swept away to other reefs!
                    </div>
                </div>
            </div>
        </section>

        <!-- 4. Graph Theory Analysis -->
        <section id="analysis" class="scroll-mt-20">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">Graph Theory: Node Roles</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Source vs Sink Dynamics -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-slate-800">Source / Sink Balance</h3>
                            <p class="text-xs text-slate-500">Total probability export vs import</p>
                        </div>
                    </div>
                    <div class="chart-container h-64">
                        <canvas id="sourceSinkChart"></canvas>
                    </div>
                    <div class="mt-6 bg-indigo-50 border border-indigo-100 rounded-lg p-4 text-sm text-slate-700 leading-relaxed">
                        <strong>ü§î How to read this chart:</strong> Think of 'Sources' (light blue) as the givers and 'Sinks' (purple) as the receivers of the seascape. Which location has the tallest light blue bar? That's your champion exporter! A healthy network needs strong sources to supply larvae to the sinks, ensuring vulnerable reefs can recover after storms or bleaching events.
                    </div>
                </div>

                <!-- Node Role Inspector -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-slate-800">Individual Profile</h3>
                        <select id="region-selector" class="text-sm border border-slate-300 rounded-md shadow-sm focus:border-sky-500 focus:ring focus:ring-sky-200 p-2 bg-slate-50 font-semibold cursor-pointer">
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="chart-container flex-grow h-64">
                        <canvas id="radarChart"></canvas>
                    </div>
                    <div id="role-description" class="mt-4 text-sm text-slate-800 bg-slate-50 p-4 rounded-t-lg border border-slate-200 border-b-0">
                        Select a location to view its specific graph theory metrics.
                    </div>
                    <div class="bg-teal-50 border border-teal-100 rounded-b-lg p-4 text-sm text-slate-700 leading-relaxed">
                        <strong>ü§î How to read this profile:</strong> This 'spider web' chart gives you a quick snapshot of a single location's personality. Is the shape pulled heavily towards 'Export Potential'? Then it's a vital nursery! Try changing the species slider: what happens to a node's 'Network Bridge' score when you switch from a Giant Clam to a Spiny Lobster?
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. Management Implications -->
        <section class="bg-slate-900 text-white rounded-2xl p-8 lg:p-10 relative overflow-hidden shadow-xl">
            <!-- Decorative background elements -->
            <div class="absolute top-0 right-0 -mt-20 -mr-20 w-96 h-96 bg-sky-500 opacity-20 rounded-full blur-3xl pointer-events-none"></div>
            <div class="absolute bottom-0 left-0 -mb-20 -ml-20 w-72 h-72 bg-teal-500 opacity-10 rounded-full blur-3xl pointer-events-none"></div>
            
            <div class="relative z-10">
                <h2 class="text-2xl font-bold mb-6 flex items-center">
                    <span class="bg-white/10 p-2 rounded-lg mr-3">üí°</span> Spatial Planning Implications
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white/5 p-6 rounded-xl border border-white/10">
                        <h4 class="font-bold text-teal-300 mb-3 text-lg">MPA Seeding Efficiency</h4>
                        <p id="mgmt-mpa" class="text-slate-300 text-sm leading-relaxed">
                            Analyzing how well <strong>MPA 1</strong>, <strong>MPA 2</strong>, and <strong>MPA 3</strong> supply larvae to surrounding areas. At the currently selected PLD, we evaluate if these strictly protected zones are effectively acting as demographic sources for the broader network, exporting more larvae than they import.
                        </p>
                    </div>
                    <div class="bg-white/5 p-6 rounded-xl border border-white/10">
                        <h4 class="font-bold text-orange-300 mb-3 text-lg">OECM Connectivity Integration</h4>
                        <p id="mgmt-oecm" class="text-slate-300 text-sm leading-relaxed">
                            Evaluating if <strong>OECM 1</strong>, <strong>OECM 2</strong>, and <strong>OECM 3</strong> function as vital stepping stones. Ensuring fisheries in these areas are managed sustainably is crucial, especially if graph analysis shows they receive heavy larval subsidies from the upstream MPAs.
                        </p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Application Logic -->
    <script>
        // --- 1. DATA & STATE ---
        
        // 6 Nodes representing hypothetical seascape locations
        const locations = [
            { id: 0, name: 'MPA 1',  type: 'MPA',   color: '#14b8a6', x: 50, y: 45 }, // Center (Teal)
            { id: 1, name: 'MPA 2',  type: 'MPA',   color: '#14b8a6', x: 80, y: 60 }, // East
            { id: 2, name: 'MPA 3',  type: 'MPA',   color: '#14b8a6', x: 15, y: 35 }, // Far West
            { id: 3, name: 'OECM 1', type: 'OECM',  color: '#fb923c', x: 30, y: 40 }, // West (Orange)
            { id: 4, name: 'OECM 2', type: 'OECM',  color: '#fb923c', x: 55, y: 75 }, // South
            { id: 5, name: 'OECM 3', type: 'OECM',  color: '#fb923c', x: 60, y: 20 }  // North
        ];
        
        const regionNames = locations.map(l => l.name);
        
        // Base Probability Matrix (6x6) for PLD = 30
        // Rows = Source, Cols = Destination
        const baseMatrixTemplate = [
            // MPA1, MPA2, MPA3, OECM1, OECM2, OECM3
            [0.45,  0.15,  0.02, 0.08, 0.20,  0.10], // MPA 1 (Source)
            [0.10,  0.60,  0.01, 0.04, 0.15,  0.10], // MPA 2 (Source)
            [0.05,  0.01,  0.65, 0.20, 0.05,  0.04], // MPA 3 (Source)
            [0.15,  0.04,  0.15, 0.50, 0.10,  0.06], // OECM 1 (Source)
            [0.25,  0.10,  0.05, 0.10, 0.45,  0.05], // OECM 2 (Source)
            [0.15,  0.10,  0.02, 0.05, 0.08,  0.60]  // OECM 3 (Source)
        ];

        // State variables
        let currentPLD = 30;
        let currentMatrix = [];
        let selectedRegionIndex = 0; 
        let spatialCanvas, ctx;

        // --- 2. CORE LOGIC ---

        // Function called by the species preset buttons
        window.setPLD = function(value) {
            document.getElementById('pld-slider').value = value;
            currentPLD = value;
            updateAll(value);
        }

        function generateMatrix(pld) {
            // Factor ranges from roughly -0.2 (low PLD) to +0.3 (high PLD)
            const factor = (pld - 30) / 100; 
            
            return baseMatrixTemplate.map((row, rIndex) => {
                return row.map((val, cIndex) => {
                    if (rIndex === cIndex) {
                        // Diagonal (Retention): Decreases as PLD goes up (larvae drift away)
                        let newVal = val - (factor * 1.8); 
                        return Math.max(0.05, Math.min(0.95, newVal));
                    } else {
                        // Off-diagonal (Dispersal): Increases as PLD goes up
                        // Add a distance/adjacency bias based on coordinates
                        const dx = locations[rIndex].x - locations[cIndex].x;
                        const dy = locations[rIndex].y - locations[cIndex].y;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        
                        // Closer islands connect faster when PLD increases
                        const distPenalty = dist / 100; 
                        let newVal = val + (factor * 0.8) - (distPenalty * 0.1) + (pld/600);
                        return Math.max(0.001, newVal);
                    }
                });
            });
        }

        function calculateMetrics(matrix) {
            return locations.map((loc, i) => {
                let retention = matrix[i][i];
                let exportSum = matrix[i].reduce((a, b) => a + b, 0) - retention;
                let importSum = matrix.map(row => row[i]).reduce((a, b) => a + b, 0) - retention;
                
                return {
                    name: loc.name,
                    type: loc.type,
                    retention: retention,
                    exportVal: exportSum,
                    importVal: importSum,
                    // Simple proxy for betweenness
                    betweenness: (exportSum * importSum) * 15 
                };
            });
        }

        // --- 3. CUSTOM HTML5 CANVAS MAP DRAWING ---

        function initMapCanvas() {
            spatialCanvas = document.getElementById('spatialMapCanvas');
            ctx = spatialCanvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function resizeCanvas() {
            const container = spatialCanvas.parentElement;
            // Handle high-DPI displays for crisp rendering
            const dpr = window.devicePixelRatio || 1;
            const rect = container.getBoundingClientRect();
            
            spatialCanvas.width = rect.width * dpr;
            spatialCanvas.height = rect.height * dpr;
            ctx.scale(dpr, dpr);
            
            drawNetworkMap(); // Redraw immediately after resize
        }

        function drawNetworkMap() {
            if (!ctx || currentMatrix.length === 0) return;
            
            const w = spatialCanvas.width / (window.devicePixelRatio || 1);
            const h = spatialCanvas.height / (window.devicePixelRatio || 1);
            
            ctx.clearRect(0, 0, w, h);

            // Calculate actual pixel coordinates from percentages
            const getCoords = (loc) => ({
                x: (loc.x / 100) * w,
                y: (loc.y / 100) * h
            });

            // 1. Draw Edges (Connections)
            const edgeThreshold = 0.03; // Only draw lines > 3% probability
            
            currentMatrix.forEach((row, sourceIdx) => {
                row.forEach((prob, destIdx) => {
                    if (sourceIdx !== destIdx && prob > edgeThreshold) {
                        const source = getCoords(locations[sourceIdx]);
                        const dest = getCoords(locations[destIdx]);
                        
                        // Use quadratic curves for visual flair instead of straight lines
                        // Curve depends on direction to separate two-way traffic
                        const midX = (source.x + dest.x) / 2;
                        const midY = (source.y + dest.y) / 2;
                        const offset = (sourceIdx > destIdx) ? 20 : -20;
                        const cpX = midX - (dest.y - source.y) * (offset / 100);
                        const cpY = midY + (dest.x - source.x) * (offset / 100);

                        ctx.beginPath();
                        ctx.moveTo(source.x, source.y);
                        ctx.quadraticCurveTo(cpX, cpY, dest.x, dest.y);
                        
                        // Style based on probability
                        const alpha = Math.min(1, prob * 3); // Scale opacity
                        ctx.strokeStyle = `rgba(14, 165, 233, ${alpha})`; // Sky blue
                        ctx.lineWidth = prob * 15; // Thicker lines for higher prob
                        ctx.stroke();

                        // Add a small directional indicator (arrow head logic simplified to a dot near destination)
                        const t = 0.8; // Position along curve
                        const arrowX = (1-t)*(1-t)*source.x + 2*(1-t)*t*cpX + t*t*dest.x;
                        const arrowY = (1-t)*(1-t)*source.y + 2*(1-t)*t*cpY + t*t*dest.y;
                        ctx.beginPath();
                        ctx.arc(arrowX, arrowY, prob * 5 + 1, 0, Math.PI*2);
                        ctx.fillStyle = `rgba(14, 165, 233, ${alpha})`;
                        ctx.fill();
                    }
                });
            });

            // 2. Draw Nodes (Locations)
            locations.forEach((loc) => {
                const pos = getCoords(loc);
                const isSelected = (loc.id === selectedRegionIndex);
                const retentionProb = currentMatrix[loc.id][loc.id];
                
                // Base shadow
                ctx.shadowColor = 'rgba(0,0,0,0.2)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetY = 4;

                // Node circle size based on retention (exaggerated multiplier for visibility)
                const radius = 10 + (retentionProb * 35);

                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                ctx.fillStyle = loc.color;
                ctx.fill();
                
                // Selection stroke
                if(isSelected) {
                    ctx.lineWidth = 3;
                    ctx.strokeStyle = '#1e293b'; // slate-800
                    ctx.stroke();
                } else {
                    ctx.lineWidth = 2;
                    ctx.strokeStyle = '#ffffff';
                    ctx.stroke();
                }
                
                // Reset shadow for text
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetY = 0;

                // Label Background
                const label = loc.name;
                ctx.font = 'bold 12px Inter, sans-serif';
                const metrics = ctx.measureText(label);
                ctx.fillStyle = 'rgba(255,255,255,0.85)';
                ctx.beginPath();
                ctx.roundRect(pos.x - metrics.width/2 - 6, pos.y + radius + 4, metrics.width + 12, 18, 4);
                ctx.fill();

                // Label Text
                ctx.fillStyle = '#334155'; // slate-700
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText(label, pos.x, pos.y + radius + 7);
            });
        }

        // --- 4. CHARTS INITIALIZATION ---

        let sourceSinkChart, radarChart;

        function initCharts() {
            // Stacked Bar
            const ctxSourceSink = document.getElementById('sourceSinkChart').getContext('2d');
            sourceSinkChart = new Chart(ctxSourceSink, {
                type: 'bar',
                data: {
                    labels: regionNames,
                    datasets: [
                        { label: 'Export (Source)', data: [], backgroundColor: '#38bdf8', borderRadius: 2 }, // Sky 400
                        { label: 'Import (Sink)', data: [], backgroundColor: '#818cf8', borderRadius: 2 },   // Indigo 400
                        { label: 'Retention', data: [], backgroundColor: '#cbd5e1', borderRadius: 2 }        // Slate 300
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: {family: 'Inter'} } } 
                    },
                    scales: { 
                        y: { beginAtZero: true, stacked: true, grid: { color: '#f1f5f9' } }, 
                        x: { stacked: true, grid: { display: false } } 
                    }
                }
            });

            // Radar Chart
            const ctxRadar = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctxRadar, {
                type: 'radar',
                data: {
                    labels: ['Local Retention', 'Export Potential', 'Import Dependency', 'Network Bridge (Betweenness)'],
                    datasets: [{
                        label: 'Metrics',
                        data: [0,0,0,0],
                        backgroundColor: 'rgba(20, 184, 166, 0.2)', // Teal 500 alpha
                        borderColor: '#14b8a6',
                        pointBackgroundColor: '#14b8a6',
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: { 
                            angleLines: { color: '#e2e8f0' }, 
                            grid: { color: '#e2e8f0' },
                            pointLabels: { font: {family: 'Inter', size: 11}, color: '#64748b' },
                            ticks: { display: false, min: 0, max: 1 } 
                        }
                    }
                }
            });
        }

        // --- 5. UPDATE CYCLE ---

        function updateAll(pld) {
            // 1. Data Math
            currentMatrix = generateMatrix(pld);
            const metrics = calculateMetrics(currentMatrix);
            
            // 2. UI Updates (Text/Sliders)
            document.getElementById('pld-value').innerText = pld;
            const insightBox = document.getElementById('pld-insight');
            
            if(pld < 20) {
                insightBox.innerHTML = `<strong>Short PLD (${pld}d):</strong> High local retention. Nodes are isolated. MPAs mostly reseed themselves. OECMs rely entirely on local management as external larval supply is low.`;
                insightBox.className = "bg-slate-100 border-l-4 border-slate-400 p-4 rounded text-sm text-slate-700 leading-relaxed transition-colors";
            } else if (pld > 45) {
                insightBox.innerHTML = `<strong>Long PLD (${pld}d):</strong> Widespread mixing. Strong connections form across the seascape. The network acts as a single, connected metapopulation where OECMs receive significant larval subsidies from distant MPAs.`;
                insightBox.className = "bg-sky-50 border-l-4 border-sky-500 p-4 rounded text-sm text-sky-900 leading-relaxed transition-colors";
            } else {
                insightBox.innerHTML = `<strong>Moderate PLD (${pld}d):</strong> A balanced state. MPAs show healthy self-seeding while actively exporting larvae to neighboring OECMs via functional corridors.`;
                insightBox.className = "bg-teal-50 border-l-4 border-teal-500 p-4 rounded text-sm text-teal-900 leading-relaxed transition-colors";
            }

            // 3. Update Custom Canvas Map
            drawNetworkMap();

            // 4. Update Matrix Heatmap (Plotly 6x6)
            const dataTrace = [{
                z: currentMatrix,
                x: regionNames,
                y: regionNames,
                type: 'heatmap',
                colorscale: [
                    ['0.0', '#f8fafc'], // slate-50
                    ['0.2', '#bae6fd'], // sky-200
                    ['0.5', '#0ea5e9'], // sky-500
                    ['1.0', '#0369a1']  // sky-800
                ],
                showscale: true,
                hovertemplate: '<b>Source:</b> %{y}<br><b>Dest:</b> %{x}<br><b>Prob:</b> %{z:.3f}<extra></extra>'
            }];
            
            const layout = {
                margin: { t: 20, b: 60, l: 80, r: 10 },
                xaxis: { tickangle: -45, title: { text: 'Destination Node', font: {size: 11, color: '#64748b'} } },
                yaxis: { title: { text: 'Source Node', font: {size: 11, color: '#64748b'} }, autorange: 'reversed' },
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent'
            };
            
            Plotly.newPlot('matrixChart', dataTrace, layout, {responsive: true, displayModeBar: false});

            // 5. Update KPI Numbers
            const totalConnections = currentMatrix.flat().filter(x => x > 0.05).length;
            const avgRetention = (metrics.reduce((acc, m) => acc + m.retention, 0) / locations.length * 100).toFixed(1);
            
            let maxVal = 0;
            let maxLink = "--";
            currentMatrix.forEach((row, r) => {
                row.forEach((val, c) => {
                    if (r !== c && val > maxVal) {
                        maxVal = val;
                        maxLink = `${locations[r].name} ‚Üí ${locations[c].name}`;
                    }
                });
            });

            document.getElementById('metric-connections').innerText = totalConnections;
            document.getElementById('metric-retention').innerText = avgRetention + "%";
            document.getElementById('metric-link').innerText = maxLink;

            // 6. Update Bar Chart
            sourceSinkChart.data.datasets[0].data = metrics.map(m => m.exportVal);
            sourceSinkChart.data.datasets[1].data = metrics.map(m => m.importVal);
            sourceSinkChart.data.datasets[2].data = metrics.map(m => m.retention);
            sourceSinkChart.update();

            // 7. Update Radar & Description
            updateRadar(selectedRegionIndex, metrics);
        }

        function updateRadar(index, metrics) {
            const m = metrics[index];
            const loc = locations[index];
            
            // Normalize for visual radar layout
            const data = [
                m.retention, 
                m.exportVal * 1.5, // Scaled for visibility
                m.importVal * 1.5, 
                Math.min(1, m.betweenness) 
            ];
            
            radarChart.data.datasets[0].data = data;
            radarChart.data.datasets[0].label = loc.name;
            radarChart.data.datasets[0].borderColor = loc.color;
            radarChart.data.datasets[0].backgroundColor = loc.type === 'MPA' ? 'rgba(20, 184, 166, 0.2)' : 'rgba(251, 146, 60, 0.2)';
            radarChart.data.datasets[0].pointBackgroundColor = loc.color;
            radarChart.update();

            // Dynamic Description tailored to MPA/OECM
            const roleDesc = document.getElementById('role-description');
            let text = `<div class="font-bold mb-1 flex items-center">
                            <span class="w-3 h-3 rounded-full inline-block mr-2" style="background-color: ${loc.color}"></span>
                            ${loc.name} (${loc.type})
                        </div>`;
            
            if (m.exportVal > m.importVal + 0.05) {
                text += `Functions strongly as a <strong>Source</strong>. `;
                if(loc.type === 'MPA') text += `This means its strict protection is successfully subsidizing other areas with larvae.`;
                else text += `Despite being an OECM, it's vital for seeding the network.`;
            } 
            else if (m.importVal > m.exportVal + 0.05) {
                text += `Functions heavily as a <strong>Sink</strong>. `;
                if(loc.type === 'OECM') text += `Its fisheries likely depend on larvae floating in from the MPAs.`;
                else text += `As an MPA, it serves to protect imported populations.`;
            } 
            else {
                text += `A balanced node. `;
            }
            
            if (m.betweenness > 0.4) {
                text += `<br><br><span class="text-sky-700">High Betweenness:</span> Critical stepping-stone. If degraded, network connectivity drops sharply.`;
            }
            
            roleDesc.innerHTML = text;

            // Highlight selected node on the map
            drawNetworkMap();
        }

        // --- 6. BOOTSTRAP ---

        document.addEventListener('DOMContentLoaded', () => {
            initMapCanvas();
            initCharts();
            
            // Populate Dropdown
            const select = document.getElementById('region-selector');
            locations.forEach((l, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.innerText = `${l.name} (${l.type})`;
                select.appendChild(opt);
            });

            // Initial Draw
            updateAll(30);

            // Event Listeners
            document.getElementById('pld-slider').addEventListener('input', (e) => {
                currentPLD = parseInt(e.target.value);
                updateAll(currentPLD);
            });

            document.getElementById('region-selector').addEventListener('change', (e) => {
                selectedRegionIndex = parseInt(e.target.value);
                const metrics = calculateMetrics(currentMatrix);
                updateRadar(selectedRegionIndex, metrics);
            });
        });

        function scrollToSection(id) {
            document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
        }

    </script>
</body>
</html>